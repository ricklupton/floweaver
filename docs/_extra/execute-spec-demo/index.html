<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>floweaver JS Executor Demo</title>
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <script src="https://unpkg.com/d3-sankey-diagram@0.9.2/build/d3-sankey-diagram.umd.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      color: #333;
      background: #fafafa;
      padding: 2rem;
    }
    h1 { font-size: 1.4rem; margin-bottom: 0.5rem; }
    p.subtitle { color: #666; margin-bottom: 1.5rem; font-size: 0.9rem; }
    .controls {
      display: flex;
      gap: 2rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }
    .control-group { display: flex; flex-direction: column; gap: 0.4rem; }
    .control-group label { font-weight: 600; font-size: 0.85rem; }
    .control-group .filename {
      font-size: 0.8rem;
      color: #888;
      font-style: italic;
    }
    button, input[type="file"]::file-selector-button {
      cursor: pointer;
      padding: 0.4rem 1rem;
      border: 1px solid #aaa;
      border-radius: 4px;
      background: #fff;
      font-size: 0.85rem;
    }
    button:hover, input[type="file"]::file-selector-button:hover {
      background: #eee;
    }
    button.primary {
      background: #4a7;
      color: #fff;
      border-color: #3a6;
      font-weight: 600;
    }
    button.primary:hover { background: #396; }
    #error {
      color: #c33;
      background: #fee;
      border: 1px solid #c33;
      padding: 0.6rem 1rem;
      border-radius: 4px;
      margin-bottom: 1rem;
      display: none;
      font-size: 0.85rem;
      white-space: pre-wrap;
    }
    #diagram-container {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 1rem;
      min-height: 400px;
    }
    #diagram-container svg { display: block; }
    .sankey .link path { opacity: 0.6; }
    .sankey .link:hover path { opacity: 0.9; }
    .sankey .node rect { fill: none; stroke: #666; stroke-width: 0.5px; }
    .sankey .group rect { fill: #f0f0f0; stroke: #ccc; }
  </style>
</head>
<body>
  <h1>floweaver JS Executor Demo</h1>
  <p class="subtitle">
    Load a compiled WeaverSpec (JSON) and a flow dataset (CSV), then render a
    Sankey diagram entirely client-side.
  </p>

  <div class="controls">
    <div class="control-group">
      <label>WeaverSpec (JSON)</label>
      <input type="file" id="spec-file" accept=".json">
      <span class="filename" id="spec-name">fruit_sales_spec.json (built-in)</span>
    </div>
    <div class="control-group">
      <label>Flow data (CSV)</label>
      <input type="file" id="data-file" accept=".csv">
      <span class="filename" id="data-name">fruit_sales.csv (built-in)</span>
    </div>
    <div class="control-group" style="justify-content: flex-end;">
      <button class="primary" id="run-btn">Run</button>
    </div>
  </div>

  <div id="error"></div>
  <div id="diagram-container">
    <svg id="sankey" width="960" height="500"></svg>
  </div>

  <!-- floweaver executor (ESM source, loaded as module) -->
  <script type="module">
    import { executeWeave } from "./floweaver-executor.esm.js";

    // ---------------------------------------------------------------
    // Default embedded data (from QuickStart tutorial last example)
    // ---------------------------------------------------------------

    let currentSpec = null;
    let currentFlows = null;

    // Load built-in defaults
    async function loadDefaults() {
      const [specResp, csvResp] = await Promise.all([
        fetch("fruit_sales_spec.json"),
        fetch("fruit_sales.csv"),
      ]);
      currentSpec = await specResp.json();
      currentFlows = parseCSV(await csvResp.text());
      render();
    }

    // ---------------------------------------------------------------
    // CSV parsing (minimal, handles the simple case)
    // ---------------------------------------------------------------

    function parseCSV(text) {
      const lines = text.trim().split("\n");
      const headers = lines[0].split(",").map(h => h.trim());
      const rows = [];
      for (let i = 1; i < lines.length; i++) {
        const vals = lines[i].split(",").map(v => v.trim());
        if (vals.length !== headers.length) continue;
        const row = {};
        for (let j = 0; j < headers.length; j++) {
          const num = Number(vals[j]);
          row[headers[j]] = isNaN(num) ? vals[j] : num;
        }
        rows.push(row);
      }
      return rows;
    }

    // ---------------------------------------------------------------
    // Convert executor output to d3-sankey-diagram widget format
    // ---------------------------------------------------------------

    function toWidgetFormat(result, spec) {
      const nodes = [];
      const links = [];

      for (const n of result.nodes) {
        const widgetNode = {
          id: n.id,
          title: (n.title != null && n.title !== "") ? n.title : n.id,
          direction: (n.direction || "R").toLowerCase(),
          hidden: n.hidden === true || n.title === "",
          type: n.style || "default",
          fromElsewhere: [],
          toElsewhere: [],
        };

        // Convert elsewhere links
        for (const el of (n.from_elsewhere_links || [])) {
          widgetNode.fromElsewhere.push({
            source: el.source,
            target: el.target,
            type: el.type,
            time: el.time,
            value: el.link_width,
            title: el.title,
            color: el.color,
            opacity: el.opacity,
            data: el.data,
          });
        }
        for (const el of (n.to_elsewhere_links || [])) {
          widgetNode.toElsewhere.push({
            source: el.source,
            target: el.target,
            type: el.type,
            time: el.time,
            value: el.link_width,
            title: el.title,
            color: el.color,
            opacity: el.opacity,
            data: el.data,
          });
        }

        nodes.push(widgetNode);
      }

      for (const l of result.links) {
        links.push({
          source: l.source,
          target: l.target,
          type: l.type,
          time: l.time,
          value: l.link_width,
          title: l.title,
          color: l.color,
          opacity: l.opacity,
          data: l.data,
        });
      }

      return {
        nodes,
        links,
        order: result.ordering,
        groups: result.groups,
      };
    }

    // ---------------------------------------------------------------
    // Render
    // ---------------------------------------------------------------

    function render() {
      const errEl = document.getElementById("error");
      errEl.style.display = "none";

      try {
        if (!currentSpec || !currentFlows) {
          throw new Error("Please load both a spec and a data file.");
        }

        // Run the executor
        const result = executeWeave(currentSpec, currentFlows);

        // Convert to widget format
        const widgetData = toWidgetFormat(result, currentSpec);

        // Clear previous diagram
        const svg = d3.select("#sankey");
        svg.selectAll("*").remove();

        // Set up layout
        const width = 960;
        const height = 500;
        svg.attr("width", width).attr("height", height);

        const layout = d3.sankey()
          .extent([[120, 20], [width - 120, height - 20]])
          .ordering(widgetData.order);

        const diagram = d3.sankeyDiagram()
          .nodeTitle(d => d.title || d.id)
          .linkColor(d => d.color || "#cccccc")
          .groups(widgetData.groups);

        // Compute layout and render
        const graph = layout(widgetData);
        svg.datum(graph).call(diagram);

      } catch (e) {
        errEl.textContent = e.message || String(e);
        errEl.style.display = "block";
        console.error(e);
      }
    }

    // ---------------------------------------------------------------
    // File input handlers
    // ---------------------------------------------------------------

    document.getElementById("spec-file").addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      document.getElementById("spec-name").textContent = file.name;
      const text = await file.text();
      try {
        currentSpec = JSON.parse(text);
      } catch (err) {
        const errEl = document.getElementById("error");
        errEl.textContent = "Invalid JSON in spec file: " + err.message;
        errEl.style.display = "block";
      }
    });

    document.getElementById("data-file").addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      document.getElementById("data-name").textContent = file.name;
      const text = await file.text();
      currentFlows = parseCSV(text);
    });

    document.getElementById("run-btn").addEventListener("click", render);

    // Load defaults and render on page load
    loadDefaults();
  </script>
</body>
</html>
